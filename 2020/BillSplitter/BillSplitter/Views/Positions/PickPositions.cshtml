@model List<BillSplitter.Models.ViewModels.PickPositions.PositionViewModel>

<table class="table">
    <thead>
        <tr>
            <th colspan="2">
                Select
            </th>

            <th>
                Name
            </th>
            <th>
                Price
            </th>
            <th>
                Quantity
            </th>
            <th>
                Already Selected By
            </th>
        </tr>
    </thead>
    <tbody>

    @foreach (var position in Model)
    {
        <tr id="partial_@position.Id">
            @await Html.PartialAsync("PickPositionsPartial",position)
        </tr>
    }
    </tbody>
</table>

<div id="enterValueDialog" class="modal fade" role="dialog">

</div>

@Html.ActionLink("View results", "ViewBill", "Bills", new
{
    billId = ViewData["billId"]
}, new
{
    @class = "btn btn-primary"
})

<script type="text/javascript">
    setInterval(() => reloadAll(), 5000);

    function reloadAll() {
        @foreach (BillSplitter.Models.ViewModels.PickPositions.PositionViewModel position in Model)
        {
          @:reload(@position.Id);
        }
    }

    function reload(id) {

        var input = document.getElementById("quantity_" + id);

        if (input != document.activeElement)
            $("#partial_" + id).load( id + "/Partial");
    }

    function positionChecked(positionId) {
        var ch = $("#" + positionId).is(":checked");
        var val = document.getElementById("quantity_" + positionId).value; 

        var quantity = parseFloat(val);
        if (quantity <= 0)
            quantity = null;
        if (ch) {
            $.ajax(positionId + "/Orders", {
                type: 'POST',
                data: { quantity: quantity },
                success: function (data, status, xhr) {
                    reloadAll();
                },

                error: function (jqXhr, textStatus, errorMessage) {
                    reloadAll();
                }
            });
        } else {
             $.ajax( positionId + "/Orders", {
                 type: 'DELETE',
                 dataType: 'text',
                success: function (data, status, xhr) {
                    reloadAll();
                },
                error: function (jqXhr, textStatus, errorMessage) {
                    reloadAll();
                 }
            });
        }
    }

    function quantityEntered(positionId)
    {
        var val = document.getElementById("quantity_" + positionId).value; 

        if (val == "" || val == "0")
            document.getElementById(positionId).checked = false;
        else
            document.getElementById(positionId).checked = true;

        positionChecked(positionId);
    }

    function selectValue(id)
    {
        $("#enterValueDialog").load(id + "/DialogPartial", function () {
            $('#enterValueDialog').modal('toggle');
        });
    }
    function submitEnteredValue(id, upperBound)
    {
        var val = $("#enteredUserQuantity").val();
        if (val < 0 || val > upperBound) {
            $("#dialogError").text("invalid value " + val);
        }
        else
        {
            document.getElementById("quantity_" + id).value = val;
            quantityEntered(id);
            $('#enterValueDialog').modal('toggle');
        }
    }


</script>